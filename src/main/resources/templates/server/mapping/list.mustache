{{>layout/header}}

<div class="right_col" role="main">
	<div class="row">
		<div class="col-md-12">
			<div class="x_panel">
				<div class="x_content">
					<div class="row">
						<div class="metatable_box col-6">
							<div class="form-group row">
								<label class="control-label">지자체명</label>
								<div class="form-control_box duplicate_box">
									<input class="form-control" type="text" name="local_gov_nm" id="local_gov_nm">
									<button class="btn btn-primary" onclick="agentRecvLocalCsvList();">
										<i class="glyphicon glyphicon-search"></i>
									</button>
								</div>
								<label class="control-label">수신파일 목록</label>
								<div class="x_content">
									<div class="table_responsive"
										style="height: 185px; overflow: auto">
										<table class="table table-striped" style="width: 100%">
											<colgroup>
											</colgroup>
											<thead>
												<tr>
													<th style="text-align: center;">지자체명</th>
													<th style="text-align: center;">수신일시</th>
													<th style="text-align: center;">파일명</th>
													<th style="text-align: center;">크기(MB)</th>
												</tr>
											</thead>
											<tbody id="agentRecvLocalCsvList">
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
						<div class="metatable_box col-6 col-lg-6">
							<div class="form-group row">
								<label class="control-label">수집 테이블 목록</label>
								<div class="form-control_box duplicate_box">
									<input class="form-control" type="text" name="input_table_nm" id="input_table_nm">
									<button class="btn btn-primary" onclick="agentRecvLocalTable();">
										<i class="glyphicon glyphicon-search"></i>
									</button>
								</div>
								<div class="x_content">
									<div class="table_responsive"
										style="height: 210px; overflow: auto">
										<table class="table table-striped" style="width: 100%">
											<colgroup>
											</colgroup>
											<thead>
												<tr>
													<th style="text-align: center;">테이블명</th>
												</tr>
											</thead>
											<tbody id="agentRecvLocalTable">
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					<br>
					<div class="row">
						<div class="metatable_box col-5">

							<div class="row">
								<div class="x_content">
									<div class="cont_title_box">
										<h2>수신파일 컬럼</h2>
									</div>
									<div class="table_responsive"
										style="height: 185px; overflow: auto">
										<table class="table table-striped" style="width: 100%">
											<colgroup>
											</colgroup>
											<thead>
												<tr>
													<th style="text-align: center;">컬럼명</th>
												</tr>
											</thead>
											<tbody id="receiveCol">
											</tbody>
										</table>
									</div>
								</div>

							</div>

						</div>

						<div class="col-2 col-lg-1 d-flex align-self-center justify-content-center p-0">
							<button class="btn btn-secondary" type="button" onclick="leftSetBtn();">
								<i class="glyphicon glyphicon-chevron-left"></i>
							</button>
							<button class="btn btn-secondary" type="button" onclick="rightSetBtn();">
								<i class="glyphicon glyphicon-chevron-right"></i>
							</button>
						</div>

						<div class="metatable_box col-5 col-lg-6">
							<div class="row">

								<h2>수집 테이블 컬럼 정보</h2>
								<div class="x_content">
									<div class="table_responsive"
										style="height: 195px; overflow: auto">
										<table class="table table-striped" style="width: 100%">
											<colgroup>
												<col width="23px">
												<col width="23px">
												<col width="17px">
												<col width="10px">
												<col width="17px">
											</colgroup>
											<thead>
												<tr>
													<th style="text-align: center;">컬럼매핑</th>
													<th style="text-align: center;">컬럼명</th>
													<th style="text-align: center;">타입</th>
													<th style="text-align: center;">길이</th>
													<th style="text-align: center;">NULL여부</th>
												</tr>
											</thead>
											<tbody id="agentRecvLocalCol">
											</tbody>
										</table>
									</div>
								</div>

							</div>
							<div class="right_btns mt-4">
								<button class="btn btn-primary" onclick="agentRecvData();">저장</button>
							</div>
						</div>
					</div>
					
					<input type="hidden" name="table_nm" id="table_nm">
					<input type="hidden" name="clct_csv_file" id=clct_csv_file>
					<input type="hidden" name="trf_zip_file" id="trf_zip_file">
					<input type="hidden" name="leftVal" id="leftVal">
					<input type="hidden" name="rightVal" id="rightVal">

				</div>
			</div>
		</div>
	</div>

</div>

{{>layout/footer}}

<script>
const url = '/server/mapping';

let dataList;

//데이터 수집 관리 
const jsList = function(){
	location.href = url+'/list';
}	

//데이터 저장
const agentRecvData = function(){
	
	let file_col_nm = [];
	let table_col_nm = [];
	if (dataList != null) {
  	    $.each(dataList, function (idx, el) {
  	    	if($("#"+el.column_name).text() != ''){
	  	    	file_col_nm.push($("#"+el.column_name).text());
	  	    	table_col_nm.push(el.column_name);
  	    	}
  	    });
	}
	
	const data = {
	   		url: '/recv/data',
	   		user_id: 'user00',
	   		table_nm: $("#table_nm").val(),
	   		table_col_nm: table_col_nm,	
	   		clct_csv_file: $("#clct_csv_file").val(),	
	   		file_col_nm: file_col_nm,	
	   		trf_zip_file: $("#trf_zip_file").val(), 		   		
	    };	
		
	    $.ajax({
	        type: 'POST',
	        url: url+'/agentRecvData',
	        dataType: 'json',
	        contentType: 'application/json; charset=utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	    	
      		let message = JSON.stringify(data.message);
      		alert(message.replace(/\"/gi, ''));            	 
      		dataList = null;
      		
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
}

//로컬DB 컬럼 조회
const agentRecvLocalCol = function(table_nm){
	
	$("#table_nm").val(table_nm);
	$("#agentRecvLocalCol").empty();
	const data = {
   		url: '/recv/local/col',
   		user_id: 'user00',
   		table_nm: table_nm
    };	
	
    $.ajax({
        type: 'POST',
        url: url+'/agentRecvLocalCol',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
  	    	dataList = data;
 	    	
 	    	let insertTr = '';
	  	    $.each(data, function (idx, el) {
				insertTr += '<tr>';
				insertTr += '	<td style="text-align: center;cursor:pointer;" onclick=rightSet("'+isEmpty(el.column_name)+'")><span id="'+el.column_name+'"></span></td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.column_name)+'</td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.data_type)+'</td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.character_maximum_length)+'</td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.is_nullable)+'</td>';
				insertTr += '</tr>';
	  	    });
			  	    
 	    	$("#agentRecvLocalCol").html(insertTr);
 	    	
	  	  }
	  	
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//로컬DB 테이블 조회
const agentRecvLocalTable = function(){
	
	$("#agentRecvLocalTable").empty();
	const data = {
   		url: '/recv/local/table',
   		user_id: 'user00',
   		table_nm: $("#input_table_nm").val()
    };	
	
    $.ajax({
        type: 'POST',
        url: url+'/agentRecvLocalTable',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
 	    	
 	    	let insertTr = '';
	  	    $.each(data, function (idx, el) {
				insertTr += '<tr>';
				insertTr += '	<td style="text-align: left;cursor:pointer;" onclick=agentRecvLocalCol("'+el+'");>'+isEmpty(el)+'</td>';
				insertTr += '</tr>';
	  	    });
			  	    
 	    	$("#agentRecvLocalTable").html(insertTr);
 	    	
	  	  }
	  	
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });		
}

const receiveCol = function(column_names, clct_csv_file, trf_zip_file){
	
	$("#clct_csv_file").val(clct_csv_file);
	$("#trf_zip_file").val(trf_zip_file);
	
	let column_name = $("#"+column_names).val().replace('[', '').replace(']', '').replace(/ /g,"");
    var jbSplit = column_name.split(',');

	let insertTr = '';
	for (var i = 0; i <jbSplit.length;i++) {
		insertTr += '<tr id="tr'+isEmpty(jbSplit[i])+'">';
		insertTr += '	<td style="text-align: left;cursor:pointer;" onclick=leftSet("'+isEmpty(jbSplit[i])+'");><span id="'+isEmpty(jbSplit[i])+'">'+isEmpty(jbSplit[i])+'</span></td>';
		insertTr += '</tr>';
    }
 	$("#receiveCol").html(insertTr);
 	
}

//지자체별 csv파일 조회
const agentRecvLocalCsvList = function(){
	
	$("#agentRecvLocalCsvList").empty();
	const data = {
   		url: '/recv/local/csv/list',
   		user_id: 'user00',
   		local_gov_nm: $("#local_gov_nm").val(),
    };	
	
    $.ajax({
        type: 'POST',
        url: url+'/agentRecvLocalCsvList',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
 	    	
 	    	let insertTr = '';
 	    	let i = 0;
	  	    $.each(data, function (idx, el) {
				insertTr += '<tr>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.local_gov_nm)+'</td>';
				insertTr += '	<td style="text-align: center;">'+el.recv_datetime+'</td>';
				insertTr += '	<td style="text-align: center;cursor:pointer;" onclick=receiveCol("column_name_'+(++i)+'","'+el.clct_csv_file+'","'+el.trf_zip_file+'");>'+el.clct_csv_file.substring(16)+'<input type=hidden name=column_name_'+(i)+' id=column_name_'+(i)+' value="'+el.column_name+'"></td>';
				insertTr += '	<td style="text-align: center;">'+el.file_size+'</td>';
				insertTr += '</tr>';
	  	    });
			  	    
 	    	$("#agentRecvLocalCsvList").html(insertTr);
 	    	
	  	  }
	  	
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

const leftSet = function(val){
	$("#leftVal").val(val);
}

const rightSet = function(val){
	$("#rightVal").val(val);
}

const leftSetBtn = function(){
 	$("#tr"+$("#"+$("#rightVal").val()).text()).show();
 	$("#"+$("#rightVal").val()).text("");
 	
 	$("#leftVal").val("");
 	$("#rightVal").val("");
}

const rightSetBtn = function(){
	
	if($("#rightVal").val() == ""){
		alert("컬럼 매핑 할곳을 선택해주세요!");
		return;
	}
	$("#"+$("#rightVal").val()).text($("#leftVal").val());
	$("#tr"+$("#leftVal").val()).hide();
	
	$("#leftVal").val("");
	$("#rightVal").val("");
}

</script>
