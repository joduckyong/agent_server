{{>layout/header}}
<div class="right_col" role="main">
	<div class="row">
		<div class="col-md-12">
			<div class="x_panel">
				<div class="x_content">
					<div class="row">
						<div class="metatable_box col-6">
							<div class="form-group row">
								<label class="control-label">지자체명</label>
								<div class="form-control_box duplicate_box">
									<input class="form-control" type="text" name="local_gov_nm" id="local_gov_nm">
									<button class="btn btn-primary" onclick="agentRecvLocalCsvList();">
										<i class="glyphicon glyphicon-search"></i>
									</button>
								</div>
								<label class="control-label">수신파일 목록</label>
								<div class="x_content">
									<div class="table_responsive" style="height: 185px; overflow: auto">
										<table class="table table-striped" style="width: 100%">
											<colgroup>
												<col width="15px">
												<col width="30px">
												<col width="40px">
												<col width="15px">
											</colgroup>
											<thead>
												<tr>
													<th style="text-align: center;">지자체명</th>
													<th style="text-align: center;">수신일시</th>
													<th style="text-align: center;">파일명</th>
													<th style="text-align: center;">크기(MB)</th>
												</tr>
											</thead>
											<tbody id="agentRecvLocalCsvList">
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
						<div class="metatable_box col-6 col-lg-6">
							<div class="form-group row">
								<label class="control-label">수집 테이블 목록</label>
								<div class="form-control_box duplicate_box">
									<input class="form-control" type="text" name="input_table_nm" id="input_table_nm">
									<button class="btn btn-primary" onclick="agentRecvLocalTable();">
										<i class="glyphicon glyphicon-search"></i>
									</button>
								</div>
								<div class="x_content">
									<div class="table_responsive" style="height: 210px; overflow: auto">
										<table class="table table-striped" style="width: 100%">
											<colgroup>
											</colgroup>
											<thead>
												<tr>
													<th style="text-align: center;">테이블명</th>
													<th style="text-align: center;">테이블 설명</th>
												</tr>
											</thead>
											<tbody id="agentRecvLocalTable" >
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					<br>
					<div class="row">
						<div class="metatable_box col-6">

							<div class="row">
								<div class="x_content">
									<div class="cont_title_box">
										<h2>수신파일 컬럼</h2>
									</div>
									<div class="table_responsive"
										style="height: 185px; overflow: auto">
										<table class="table table-striped" style="width: 100%">
											<colgroup>
											</colgroup>
											<thead>
												<tr>
													<th style="text-align: center;">컬럼명</th>
												</tr>
											</thead>
											<tbody id="receiveCol" ondrop="drop(event)" ondragover="allowDrop(event)">
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>

						<div class="metatable_box col-6 col-lg-6">
							<div class="row">

								<h2>수집 테이블 컬럼 정보</h2>
								<div class="x_content">
									<div class="table_responsive"
										style="height: 195px; overflow: auto">
										<table class="table table-striped" style="width: 100%">
											<colgroup>
												<col width="23px">
												<col width="23px">
												<col width="17px">
												<col width="10px">
												<col width="17px">
											</colgroup>
											<thead>
												<tr>
													<th style="text-align: center;">컬럼매핑</th>
													<th style="text-align: center;">컬럼명</th>
													<th style="text-align: center;">타입</th>
													<th style="text-align: center;">길이</th>
													<th style="text-align: center;">NULL여부</th>
												</tr>
											</thead>
											<tbody id="agentRecvLocalCol">
											</tbody>
										</table>
									</div>
								</div>

							</div>
							<div class="right_btns mt-4">
								<button class="btn btn-primary" onclick="agentRecvData();">저장</button>
							</div>
						</div>
					</div>
					
					<input type="hidden" name="table_nm" id="table_nm">
					<input type="hidden" name="clct_csv_file" id=clct_csv_file>
					<input type="hidden" name="trf_zip_file" id="trf_zip_file">
					<input type="hidden" name="file_nm" id="file_nm">

				</div>
			</div>
		</div>
	</div>

</div>

{{>layout/footer}}

<script>
const url = '/server/mapping';

let dataList;

//데이터 수집 관리 
const jsList = function(){
	location.href = url+'/list';
}	

//데이터 저장
const agentRecvData = function(){
	
	let file_col_nm = [];
	let table_col_nm = [];
	let file_col_nm_len = [];
	let null_yn_len = [];
	
	if (dataList != null) {
  	    $.each(dataList, function (idx, el) {
  	    	if($("#drop_"+el.column_name).text() != ''){
	  	    	file_col_nm.push($("#drop_"+el.column_name).text());
	  	    	table_col_nm.push(el.column_name);
	  	    	file_col_nm_len.push(idx);
	//  	    	console.log('idx ==  '+idx);  	 
  	    	}
  	    	if(el.is_nullable == "NO"){
  	    		null_yn_len.push(idx);
	//			console.log('idx: '+idx+', el.is_nullable: '+el.is_nullable);  	    	
  	    	}  	    	
  	    });
	}
	
	if (dataList != null) {
		let values = null_yn_len.filter(x => !file_col_nm_len.includes(x));
		if(values != ''){
			alert("NULL여부 확인해 주세요!");
			return;
		}
	}
	
	
	const data = {
	   		url: '/recv/data',
	   		user_id: 'user00',
	   		table_nm: $("#table_nm").val(),
	   		table_col_nm: table_col_nm,	
	   		clct_csv_file: $("#clct_csv_file").val(),	
	   		recv_zip_file: $("#trf_zip_file").val(), 		
	   		file_col_idx: file_col_nm_len,
	   		file_nm:  $("#file_nm").val(), 
	    };	
		
	    $.ajax({
	        type: 'POST',
	        url: url+'/agentRecvData',
	        dataType: 'json',
	        contentType: 'application/json; charset=utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	    	
      		let message = JSON.stringify(data.message);
      		alert(message.replace(/\"/gi, ''));            	 
      		dataList = null;
      		
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
}

//로컬DB 컬럼 조회
const agentRecvLocalCol = function(table_nm){
	
	$("#table_nm").val(table_nm);
	$("#agentRecvLocalCol").empty();
	const data = {
   		url: '/recv/local/col',
   		user_id: 'user00',
   		table_nm: table_nm
    };	
	
    $.ajax({
        type: 'POST',
        url: url+'/agentRecvLocalCol',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
  	    	dataList = data;
 	    	
 	    	let insertTr = '';
	  	    $.each(data, function (idx, el) {
				insertTr += '<tr>';
				insertTr += '	<td style="text-align: center;cursor:pointer;" ondrop="drop(event)" ondragover="allowDrop(event)" id="drop_'+el.column_name+'"></td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.column_name)+'</td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.data_type)+'</td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.character_maximum_length)+'</td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.is_nullable)+'</td>';
				insertTr += '</tr>';
	  	    });
			  	    
 	    	$("#agentRecvLocalCol").html(insertTr);
	
	  	  }
	  
	  	
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//로컬DB 테이블 조회
const agentRecvLocalTable = function(){
	
	$("#agentRecvLocalTable").empty();
	const data = {
   		url: '/recv/local/table',
   		user_id: 'user00',
   		table_nm: $("#input_table_nm").val()
    };	
	
    $.ajax({
        type: 'POST',
        url: url+'/agentRecvLocalTable',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
 	    	
 	    	let insertTr = '';
	  	    $.each(data.tbl_list, function (idx, el) {
				insertTr += '<tr>';
				insertTr += '	<td style="text-align: left;cursor:pointer;" onclick=agentRecvLocalCol("'+el.tbl_nm+'");>'+isEmpty(el.tbl_nm)+'</td>';
				insertTr += '	<td style="text-align: left;cursor:pointer;" >'+isEmpty(el.tbl_desc)+'</td>';
				insertTr += '</tr>';
	  	    });
			  	    
 	    	$("#agentRecvLocalTable").html(insertTr);
 	    	
	  	  }
	  	
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });		
}

const receiveCol = function(column_names, clct_csv_file, trf_zip_file, file_nm){
	
	$("#clct_csv_file").val(clct_csv_file);
	$("#trf_zip_file").val(trf_zip_file);
	$("#file_nm").val(file_nm);
	
	let column_name = $("#"+column_names).val();
	
	let insertTr = '';
    $.each(column_name, function (idx, el) {
		insertTr += '<tr id="tr'+isEmpty(el.file_col_nm)+'">';
		insertTr += '	<td style="text-align: left;cursor:pointer;" ><span draggable="true" ondragstart="drag(event)" id="'+isEmpty(el.file_col_nm)+'">'+isEmpty(el.file_col_nm)+'</span></td>';
		insertTr += '</tr>';
    });
    $("#receiveCol").html(insertTr);
    
	/*
	let column_name = $("#"+column_names).val().replace('[', '').replace(']', '').replace(/ /g,"");
    var jbSplit = column_name.split(',');

	let insertTr = '';
	for (var i = 0; i <jbSplit.length;i++) {
		insertTr += '<tr id="tr'+isEmpty(jbSplit[i])+'">';
		insertTr += '	<td style="text-align: left;cursor:pointer;" ><span draggable="true" ondragstart="drag(event)" id="'+isEmpty(jbSplit[i])+'">'+isEmpty(jbSplit[i])+'</span></td>';
		insertTr += '</tr>';
    }
 	$("#receiveCol").html(insertTr);
 	*/
}

//지자체별 csv파일 조회
const agentRecvLocalCsvList = function(){
	
	$("#agentRecvLocalCsvList").empty();
	const data = {
   		url: '/recv/local/csv/list',
   		user_id: 'user00',
   		local_gov_nm: $("#local_gov_nm").val(),
    };	
	
    $.ajax({
        type: 'POST',
        url: url+'/agentRecvLocalCsvList',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
 	    	
 	    	let insertTr = '';
 	    	let i = 0;
	  	    $.each(data, function (idx, el) {
				insertTr += '<tr>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.code_nm)+'</td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.recv_datetime)+'</td>';
				insertTr += '	<td style="text-align: center;cursor:pointer;" onclick=receiveCol("column_name_'+(++i)+'","'+el.clct_csv_file+'","'+el.recv_zip_file+'","'+el.file_nm+'");>'+isEmpty(el.file_nm)+'<input type=hidden name=column_name_'+(i)+' id=column_name_'+(i)+' value="'+el.col_info+'"></td>';
				insertTr += '	<td style="text-align: center;">'+isEmpty(el.clct_csv_file_size)+'</td>';
				insertTr += '</tr>';
	  	    });
			  	    
 	    	$("#agentRecvLocalCsvList").html(insertTr);
 	    	
	  	  }
	  	
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}


const allowDrop = function(allowdropevent) {
    allowdropevent.preventDefault();
}

const drag = function(dragevent) {
    dragevent.dataTransfer.setData("text", dragevent.target.id);
}

const drop= function(dropevent) {
    dropevent.preventDefault();
    var data = dropevent.dataTransfer.getData("text");
    dropevent.target.appendChild(document.getElementById(data));
}
</script>
